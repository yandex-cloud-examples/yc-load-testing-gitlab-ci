# Как описывать тесты, которые необходимо запускать в CI

Конфигурация каждого теста должна лежать в отдельной папке. Имя конфигурационного файла должно соответствовать маске `test-config*.yaml`.

---

### TL;DR

_**Примеры описанных тестов можно посмотреть [тут](sample-tests/README.md).**_

В папку с файлами конфигурации можно добавить следующие файлы:
- В файле `meta.json` можно описать св-ва теста (все поля опциональны):
    ```yaml
    # имя теста
    name: str
    # описание теста
    description: str
    # лейблы теста
    labels: {"test-label": "value"}
    # лейблы агентов, на которых тест нужно запускать
    agent_labels: {"agent-label": "value"}
    # количество агентов на каждый файл с конфигурацией
    multi: 1 
    # массив с описанием откуда брать внешние файлы (вне репозитория)
    external_data: [{"name": "", "s3bucket": "", "s3file": ""}]
    ```
- В файле `check_summary.sh` можно написать валидацию `yc loadtesting test get $test_id`
- В файле `check_report.sh` можно написать валидацию `yc loadtesting test get-report-tables $test_id`

---

### Конфигурация теста через `meta.json`

Некоторые настройки теста можно определить в файле `meta.json`.

- имя теста:

    ```json
    {
        "name": "smoke"
    }
    ```
- описание теста:

    ```json
    {
        "description": "If this test fails... ALARM!!!!!!!!!"
    }
    ```
- метки теста:
    ```json
    {
        "labels": {
            "k1": "v1",
            "k2": "v2"
        }
    }
    ```
- требования к агенту, через спецификацию меток, которые должны быть у него проставлены:
    ```json
    {
        "agent_labels": {
            "net": "1gb",
            "disk": "ssd"
        }
    }
    ```

---

### Передача тестовых данных на агент

#### Из репозитория:

Каждый файл, дополнительный файл, находящийся в папке с конфигурационным файлом, перед выполнением теста будет загружен в бакет Object Storage (определяется переменной среды `YC_LT_DATA_BUCKET`). Во время выполнения теста, агент скачивает эти файлы и может использовать их в качестве тестовых данных.

#### Из бакета Object Storage

В файле `meta.json` можно описать секцию `external_data`, в которой должно быть определен список из структур, определяющих имя бакета, имя файла в бакете, и имя, которое агент даст файлу при скачивании.

Пример:
```json
{
    "external_data": [
        {
            "s3bucket": "loadtesting-data",
            "s3file": "folder/user-data.json",
            "name": "data.json"
        },
        {
            "s3bucket": "loadtesting-data",
            "s3file": "folder/payload.uri",
            "name": "payload.uri"
        }
    ]
}
```

---

### Запуск теста на нескольких агентах одновременно (aka мультитест)

В файле `meta.json` можно указать параметр `multi`, присвоив ему значение, равное желаемому количеству агентов, на которых тест будет выполняться одновременно.

```json
{
    "multi": 3
}
```

_**WARNING: если на момент запуска теста, необходимое количество агентов не будет подключено к сервису, тест не запустится.**_

---

### Валидация результатов проведенного теста в CI

По умолчанию, система запуска уже выполняет некоторые проверки. В каждом тесте эти проверки можно переопределить, добавив в папку с тестом проверочные скрипты `check_summary.sh` и `check_result.sh`.

По завершению выполнения теста, эти скрипты будут вызваны в виде, аналогичном следующему:

```sh
# download results

yc --format json loadtesting test get "$test_id" > summary.json
yc --format json loadtesting test get-report-table "$test_id" > report.json

# check

bash $test_dir/check_summary.sh summary.json
rc1=$?

bash $test_dir/check_report.sh report.json
rc2=$?

((rc1 == 0 && rc2 == 0))
```

Тест считается упавшим, если один из скриптов завершился с ошибкой (`exit_code != 0`).

_**Прим: полностью выключить проверки можно, указав YC_LT_SKIP_TEST_CHECK=1**_
